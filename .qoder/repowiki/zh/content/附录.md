# 附录

<cite>
**本文档中引用的文件**
- [UserStatus.java](file://src/main/java/com/example/nettyim/entity/enums/UserStatus.java)
- [Result.java](file://src/main/java/com/example/nettyim/dto/Result.java)
- [BusinessException.java](file://src/main/java/com/example/nettyim/exception/BusinessException.java)
- [CLUSTER_DEPLOYMENT.md](file://CLUSTER_DEPLOYMENT.md)
- [application.yml](file://src/main/resources/application.yml)
</cite>

## 目录
1. [枚举类型定义](#枚举类型定义)
2. [全局响应结构](#全局响应结构)
3. [业务异常类型](#业务异常类型)
4. [常见问题解答](#常见问题解答)
5. [术语表](#术语表)

## 枚举类型定义

### 用户状态枚举 (UserStatus)
- **DISABLED (0)**: 禁用 - 用户账户被系统或管理员禁用，无法登录和使用服务
- **ENABLED (1)**: 启用 - 用户账户正常可用，可以正常登录和使用服务

### 在线状态枚举 (OnlineStatus)
- **OFFLINE (0)**: 离线 - 用户未连接到系统，无法接收实时消息
- **ONLINE (1)**: 在线 - 用户已连接到系统，可以实时接收消息
- **BUSY (2)**: 忙碌 - 用户在线但处于忙碌状态，可能无法及时响应
- **AWAY (3)**: 离开 - 用户在线但暂时离开，可能长时间无操作

### 好友关系状态枚举 (FriendshipStatus)
- **PENDING (0)**: 待确认 - 好友申请已发送，等待对方确认
- **ACCEPTED (1)**: 已同意 - 好友关系已建立，双方互为好友
- **REJECTED (2)**: 已拒绝 - 对方拒绝了好友申请
- **DELETED (3)**: 已删除 - 好友关系已被删除

### 群组成员角色枚举 (GroupMemberRole)
- **MEMBER (0)**: 普通成员 - 群组的普通成员，具有基本权限
- **ADMIN (1)**: 管理员 - 群组管理员，具有管理成员和消息的权限
- **OWNER (2)**: 群主 - 群组创建者，拥有最高管理权限

### 消息类型枚举 (MessageType)
- **TEXT (1)**: 文本 - 纯文本消息
- **IMAGE (2)**: 图片 - 图片文件消息
- **FILE (3)**: 文件 - 通用文件消息
- **VOICE (4)**: 语音 - 语音消息
- **VIDEO (5)**: 视频 - 视频文件消息
- **SYSTEM (6)**: 系统消息 - 系统自动生成的通知消息

### 会话类型枚举 (ConversationType)
- **PRIVATE (1)**: 私聊 - 两个用户之间的私人对话
- **GROUP (2)**: 群聊 - 多个用户参与的群组对话

**Section sources**
- [UserStatus.java](file://src/main/java/com/example/nettyim/entity/enums/UserStatus.java#L3-L153)

## 全局响应结构

### Result.java 响应结构
全局响应结构 `Result<T>` 用于统一API的返回格式，包含以下字段：

| 字段 | 类型 | 描述 |
|------|------|------|
| code | Integer | 响应状态码，200表示成功，其他为错误码 |
| message | String | 响应消息，描述操作结果或错误信息 |
| data | T | 响应数据，泛型类型，包含具体的业务数据 |
| timestamp | Long | 时间戳，记录响应生成的时间 |

### 响应模式使用示例
- **成功响应**: 使用 `Result.success()` 或 `Result.success(data)` 方法，返回code=200，message="操作成功"
- **错误响应**: 使用 `Result.error(message)` 方法，返回code=500，包含错误信息
- **特定错误码**: 使用 `Result.error(code, message)` 方法，返回自定义错误码和消息
- **未授权访问**: 使用 `Result.unauthorized(message)` 方法，返回code=401
- **权限不足**: 使用 `Result.forbidden(message)` 方法，返回code=403
- **资源未找到**: 使用 `Result.notFound(message)` 方法，返回code=404

**Section sources**
- [Result.java](file://src/main/java/com/example/nettyim/dto/Result.java#L3-L56)

## 业务异常类型

### BusinessException.java
业务异常类 `BusinessException` 继承自 `RuntimeException`，用于处理业务逻辑中的异常情况。

#### 构造方法
- `BusinessException(String message)`: 创建异常，code默认为500
- `BusinessException(Integer code, String message)`: 创建异常，指定错误码和消息
- `BusinessException(String message, Throwable cause)`: 创建异常，包含底层异常原因，code默认为500

#### 常见错误码及处理建议
| 错误码 | 错误信息 | 解决建议 |
|--------|---------|---------|
| 500 | 通用业务异常 | 检查业务逻辑，查看详细日志定位问题 |
| 400 | 请求参数错误 | 检查请求参数是否符合API文档要求 |
| 401 | 未授权访问 | 检查JWT Token是否有效，是否已登录 |
| 403 | 权限不足 | 检查用户角色和权限，确认是否有操作权限 |
| 404 | 资源未找到 | 检查请求的资源ID是否存在 |
| 409 | 资源冲突 | 检查是否存在重复数据或状态冲突 |
| 429 | 请求过于频繁 | 降低请求频率，遵循限流策略 |

**Section sources**
- [BusinessException.java](file://src/main/java/com/example/nettyim/exception/BusinessException.java#L3-L31)

## 常见问题解答

### 如何修改SocketIO端口？
在 `application.yml` 配置文件中修改 `socketio.port` 属性值。例如，将端口修改为9091：
```yaml
socketio:
  port: 9091
```
同时需要修改 `server.port` 以避免端口冲突。

**Section sources**
- [application.yml](file://src/main/resources/application.yml#L60-L72)

### 集群模式下如何保证消息顺序？
系统通过以下机制保证消息顺序：
1. **Redis消息队列**: 使用Redis作为消息中间件，保证消息的有序性
2. **会话亲和性**: Nginx配置ip_hash，确保同一用户的连接路由到同一节点
3. **序列号机制**: 消息携带序列号，客户端根据序列号排序显示
4. **事务处理**: 关键操作使用数据库事务保证一致性

**Section sources**
- [CLUSTER_DEPLOYMENT.md](file://CLUSTER_DEPLOYMENT.md#L1-L201)

### 如何处理大量历史消息查询性能问题？
优化历史消息查询性能的建议：
1. **分页查询**: 使用分页参数（page, size）限制单次查询数量
2. **索引优化**: 在消息表的 `conversation_id`、`create_time` 字段上建立复合索引
3. **缓存机制**: 将近期热门会话的消息缓存到Redis
4. **归档策略**: 对超过一定时间的历史消息进行归档存储
5. **异步查询**: 对大量数据查询使用异步接口，避免阻塞

**Section sources**
- [CLUSTER_DEPLOYMENT.md](file://CLUSTER_DEPLOYMENT.md#L1-L201)

## 术语表

### 会话（Session）
指用户与服务器之间的连接会话。在本系统中，会话信息存储在Redis中，包含用户连接状态、SocketIO会话ID等信息，支持集群环境下的会话共享。

### 会话（Conversation）
指用户之间的对话记录。分为私聊会话和群聊会话，每个会话有唯一的会话ID，包含该会话下的所有消息记录。会话信息持久化存储在数据库中。

### 路由（Routing）
指消息在集群环境中的转发机制。当用户A向用户B发送消息时，系统需要确定用户B当前连接的服务器节点，并将消息路由到该节点进行投递。路由基于Redis的发布/订阅机制实现。

**Section sources**
- [CLUSTER_DEPLOYMENT.md](file://CLUSTER_DEPLOYMENT.md#L1-L201)