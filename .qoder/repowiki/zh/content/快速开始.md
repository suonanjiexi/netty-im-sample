# 快速开始

<cite>
**本文档引用文件**  
- [application.yml](file://src/main/resources/application.yml)
- [application-cluster.yml](file://src/main/resources/application-cluster.yml)
- [schema.sql](file://src/main/resources/schema.sql)
- [NettyImApplication.java](file://src/main/java/com/example/nettyim/NettyImApplication.java)
- [start-cluster.sh](file://start-cluster.sh)
- [stop-cluster.sh](file://stop-cluster.sh)
- [CLUSTER_DEPLOYMENT.md](file://CLUSTER_DEPLOYMENT.md)
</cite>

## 目录
1. [环境先决条件](#环境先决条件)
2. [本地单机运行步骤](#本地单机运行步骤)
3. [集群部署流程](#集群部署流程)
4. [多节点通信机制验证](#多节点通信机制验证)
5. [常见初始化问题排查](#常见初始化问题排查)

## 环境先决条件

在开始运行本项目之前，请确保您的开发环境已安装以下软件：

- **Java 8+**：建议使用 JDK 21 以获得最佳兼容性
- **Maven 3.6+**：用于项目依赖管理和构建
- **MySQL 5.7+（推荐 8.0+）**：用于持久化存储用户、消息等数据
- **Redis 6+**：用于会话共享和集群间消息通信

请确保 MySQL 和 Redis 服务已启动并可正常连接。

**Section sources**
- [CLUSTER_DEPLOYMENT.md](file://CLUSTER_DEPLOYMENT.md#L25-L30)

## 本地单机运行步骤

### 1. 导入项目
使用 IntelliJ IDEA 或 Eclipse 等 IDE 导入本项目，确保 Maven 依赖自动下载完成。

### 2. 配置数据库与 Redis 连接
编辑 `src/main/resources/application.yml` 文件中的数据库和 Redis 配置：

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/netty_im?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: root
  data:
    redis:
      host: localhost
      port: 6379
```

根据您的实际环境修改 `username`、`password` 及连接地址。

### 3. 初始化数据库
执行 `src/main/resources/schema.sql` 文件以创建数据库和表结构：

```bash
mysql -u root -p < src/main/resources/schema.sql
```

该脚本将创建 `netty_im` 数据库及用户、消息、群组等相关表，并插入测试用户数据。

### 4. 编译并运行项目
通过 Maven 编译并运行主类：

```bash
mvn clean package -DskipTests
java -jar target/netty-im-sample-0.0.1-SNAPSHOT.jar
```

或直接在 IDE 中运行 `NettyImApplication.java` 的 `main` 方法。

项目启动后，HTTP 服务将运行在 `8080` 端口，SocketIO 服务运行在 `8081` 端口。

**Section sources**
- [application.yml](file://src/main/resources/application.yml#L5-L25)
- [schema.sql](file://src/main/resources/schema.sql#L1-L10)
- [NettyImApplication.java](file://src/main/java/com/example/nettyim/NettyImApplication.java#L15-L18)

## 集群部署流程

### 1. 配置集群节点信息
使用 `application-cluster.yml` 启用集群模式：

```yaml
socketio:
  cluster:
    enabled: true
    nodeId: ${NODE_ID:node-1}
```

通过环境变量 `NODE_ID` 区分不同节点。

### 2. 启动集群实例
使用提供的脚本一键启动三节点集群：

```bash
./start-cluster.sh
```

该脚本将自动：
- 检查 Redis 和 MySQL 服务状态
- 清理旧进程
- 编译项目
- 启动三个独立实例，分别监听：
  - 节点1：HTTP=8080，SocketIO=8081
  - 节点2：HTTP=8082，SocketIO=8083
  - 节点3：HTTP=8084，SocketIO=8085

日志将输出至 `logs/node1.log`、`logs/node2.log`、`logs/node3.log`。

### 3. 停止集群服务
使用以下命令停止所有节点：

```bash
./stop-cluster.sh
```

该脚本将优雅关闭所有运行中的进程。

**Section sources**
- [application-cluster.yml](file://src/main/resources/application-cluster.yml#L34-L39)
- [start-cluster.sh](file://start-cluster.sh#L1-L86)
- [stop-cluster.sh](file://stop-cluster.sh#L1-L36)

## 多节点通信机制验证

参考 `CLUSTER_DEPLOYMENT.md` 文档，可通过以下方式验证集群通信：

### 1. 日志观察节点发现
查看各节点日志，确认 Redisson 分布式锁和会话同步机制正常工作：

```bash
tail -f logs/node1.log
```

应能看到用户连接、会话创建、消息广播等日志信息。

### 2. 跨节点发送消息测试
使用不同端口连接不同节点的客户端：

```javascript
// 连接节点1
const socket1 = io('http://localhost:8081?userId=1');
// 连接节点2
const socket2 = io('http://localhost:8083?userId=2');
```

从 `socket1` 向 `socket2` 发送私聊消息，验证消息能否通过 Redis 队列正确路由并接收。

### 3. 群聊消息广播
创建群组并将成员分配至不同节点，发送群聊消息，验证所有成员是否都能收到。

**Section sources**
- [CLUSTER_DEPLOYMENT.md](file://CLUSTER_DEPLOYMENT.md#L100-L130)

## 常见初始化问题排查

### 1. 端口冲突
**现象**：启动失败，提示端口已被占用。  
**解决**：检查 `8080`、`8081`、`8082` 等端口是否被其他进程占用，使用 `netstat -tlnp | grep <port>` 查看并终止冲突进程。

### 2. 数据库连接失败
**现象**：启动时报 `Cannot connect to database`。  
**解决**：
- 确认 MySQL 服务已启动
- 检查 `application.yml` 中的用户名、密码、URL 是否正确
- 确保 `schema.sql` 已成功执行

### 3. Redis 无法连接
**现象**：启动时报 `Redis connection refused`。  
**解决**：
- 确认 Redis 服务已启动：`redis-cli ping` 应返回 `PONG`
- 检查 `application.yml` 中 Redis 配置
- 确保防火墙未阻止 6379 端口

### 4. 集群节点无法通信
**现象**：跨节点消息无法接收。  
**解决**：
- 确认所有节点 `socketio.cluster.enabled` 为 `true`
- 检查各节点 `nodeId` 是否唯一
- 使用 `redis-cli keys "socketio*"` 确认 Redis 中存在会话和消息键

**Section sources**
- [CLUSTER_DEPLOYMENT.md](file://CLUSTER_DEPLOYMENT.md#L180-L201)
- [start-cluster.sh](file://start-cluster.sh#L10-L20)